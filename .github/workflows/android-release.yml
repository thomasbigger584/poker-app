name: ğŸš€ Create Android Release

on:
  push:
    branches: [ "master" ]
    paths:
      - "client/android/**"

jobs:
  build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./client/android

    steps:
      - name: ğŸ“‹ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: âš™ï¸ Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: ğŸ› ï¸ Build Debug APK
        run: ./gradlew assembleDebug

      - name: â¬†ï¸ Upload Debug APK as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk-artifact
          path: client/android/app/build/outputs/apk/debug/app-debug.apk

  release:
    needs: build
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: ğŸ“‹ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ·ï¸ Get Release Metadata
        id: release_meta
        run: |
          RELEASE_TAG="v$(date +'%Y.%m.%d-%H%M')"
          SHORT_SHA=$(git rev-parse --short HEAD)
          RELEASE_APK_NAME="poker-app-${RELEASE_TAG}.apk" 

          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "release_name=ğŸš€ Poker App Android (${RELEASE_TAG})" >> $GITHUB_OUTPUT
          echo "release_apk_name=$RELEASE_APK_NAME" >> $GITHUB_OUTPUT

      - name: â¬‡ï¸ Download APK Artifact
        uses: actions/download-artifact@v4
        with:
          name: debug-apk-artifact
          path: artifacts/

      - name: ğŸ“ Rename Artifact
        run: |
          mv artifacts/app-debug.apk artifacts/${{ steps.release_meta.outputs.release_apk_name }}

      - name: ğŸ“œ Generate Commit Log
        id: commit_log
        run: |
          FILTER_PATH="client/android"
          END_SHA="HEAD"
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 --exclude='${{ steps.release_meta.outputs.release_tag }}' HEAD^ 2>/dev/null || echo "not_found")
          
          if [ "$PREVIOUS_TAG" = "not_found" ]; then
            LOG_RANGE="--root"
            MAX_COUNT="--max-count=10"
            LOG_RANGE_INFO="Last Few commits (Initial Release)"
          else
            LOG_RANGE="$PREVIOUS_TAG..$END_SHA"
            MAX_COUNT=""
            LOG_RANGE_INFO="\`$PREVIOUS_TAG\`...`$END_SHA`"
          fi

          # 1. git log: gets hash and subject, filtered by path and range.
          # 2. awk: tracks seen subjects ($2), prints only if new, then adds the author.
          COMMIT_HISTORY=$(git log $MAX_COUNT $LOG_RANGE --pretty=format:'%h %s - *%an*' -- $FILTER_PATH | \
            awk '
            {
                hash = $1;
                message = substr($0, length(hash) + 2); 
                match(message, /\*.*\*/)
                author = substr(message, RSTART, RLENGTH)
                subject = substr(message, 1, RSTART - 4)
          
                if (!(subject in seen)) {
                    print "* `" hash "` " subject " " author
                    seen[subject] = 1;
                }
            }
          ')
          # -------------------------------------------
          
          # --- Release Body Generation ---
          {
            echo "## âœ¨ Release Overview"
            echo ""
            echo "This is a pre-release **Debug** build triggered by the latest changes to the \`client/android\` path on the \`master\` branch."
            echo ""
            echo "***"
            echo ""
            echo "## ğŸ“ Changes Included in This Build"
            echo "Log range: $LOG_RANGE_INFO"
            echo ""
          
            if [ -z "$COMMIT_HISTORY" ]; then
              echo "_No new commits were detected in this range that affected \`$FILTER_PATH\`._"
            else
              echo "$COMMIT_HISTORY"
            fi
          
            echo ""
            echo "***"
            echo ""
            echo "## ğŸ“¥ Installation Details"
            echo ""
            echo "* **File:** \`${{ steps.release_meta.outputs.release_apk_name }}\`"
            echo "* **Source Commit:** \`${{ steps.release_meta.outputs.short_sha }}\`"
            echo "* **Target Branch:** \`${{ github.ref_name }}\`"
          } > release_body.txt
          
          echo "COMMIT_LOG<<EOF" >> $GITHUB_OUTPUT
          cat release_body.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ“¦ Create GitHub Release and Upload APK
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_meta.outputs.release_tag }}
          name: ${{ steps.release_meta.outputs.release_name }}
          prerelease: true
          body: ${{ steps.commit_log.outputs.COMMIT_LOG }}
          files: artifacts/${{ steps.release_meta.outputs.release_apk_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#
      - name: ğŸ—‘ï¸ Cleanup Older Releases
        uses: dev-drprasad/delete-older-releases@v0.3.4 # Not Maintained
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
